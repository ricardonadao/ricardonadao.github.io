---
layout: post
author: Ricardo Adao
published: true
post_date: 2018-07-02 09:23:49
title: PowerCLI - Configure multiple ESXi Power Policy
categories: [ powercli ]
tags: [ coding, powercli, powershell, vcenter, vmware, powersaving ]
---
<p>This is a quick powershell script that setups the <em>power policies</em> in all the hosts of a cluster or vCenter.</p>
<h4>The script has 4 mandatory parameters and 1 optional parameter:</h4>
<ul>
<li>Mandatory:
<ul>
<li><strong><em>vCenter</em> </strong>- vCenter FQDN/IP to connect too</li>
<li><strong><em>vCenterUsername</em> </strong>- vCenter Username</li>
<li><strong><em>vCenterPassword</em> </strong>- corresponding password</li>
<li><strong><em>powerProfile</em> </strong>- <em>Power Profile</em> config to use:
<ul>
<li><em>High Performance</em></li>
<li><em>Balanced</em></li>
<li><em>Low Power</em></li>
<li><em>Custom</em></li>
</ul>
</li>
</ul>
</li>
<li>Optional:
<ul>
<li><strong><em>cluster</em></strong> - Cluster name if we want to change the hosts from a single cluster</li>
</ul>
</li>
</ul>
<h4>The code is pretty simple, but it worth to point out the relevant parts of it:</h4>
<ul>
<li style="list-style-type: none;">
<ul>
<li><em>Hash Table</em> to adapt/translate the common name of the <em>Power Policies</em> to the right value needed by the <em>ConfigurePowerPolicy method</em>
<pre lang="powershell"># Keys for the values needed for the ConfigurePowerPolicy method
$powerProfiles =  @{
    "High Performance" = 1 ;
    "Balanced"         = 2 ;
    "Low Power"        = 3 ;
    "Custom"           = 4
}</pre>
</li>
</ul>
<ul>
<li>List the current status
<pre lang="powershell">$currentState = $vmHosts | Sort-Object $_.Name| `
 Select Name,@{ N="CurrentPolicy"; E={$_.ExtensionData.config.PowerSystemInfo.CurrentPolicy.ShortName}}, `
 @{ N="CurrentPolicyKey"; E={$_.ExtensionData.config.PowerSystemInfo.CurrentPolicy.Key}}, `
 @{ N="AvailablePolicies"; E={$_.ExtensionData.config.PowerSystemCapability.AvailablePolicy.ShortName}}

 $currentState | Format-Table -AutoSize</pre>
</li>
</ul>
<ul>
<li>Change effectively the <em>Power Policy</em>
<pre lang="powershell"># Set the PowerProfile to the desired state
(Get-View ($vmHosts | Get-View).ConfigManager.PowerSystem).ConfigurePowerPolicy($powerProfiles.$powerProfile)</pre>
</li>
</ul>
</li>
<li>
<h3><em>Github</em> Link for the entire script: <a id="3d163e1fcac63cc037cc983ff10e168a-60e6d2bfcfa450134efd0cce791b92c4804eebf7" class="js-navigation-open" title="set.esxi.power.settings.ps1" href="https://github.com/ricardonadao/vrandombites.co.uk/blob/master/ESXi/set.esxi.power.settings.ps1">set.esxi.power.settings.ps1</a></h3>
</li>
</ul>
