---
layout: post
title: Run Nested ESXi on top of a vSAN datastore
date: 2018-07-19 18:20:14.000000000 +01:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- vSAN
tags:
- coding
- esxi
- hypervisor
- nested
- oneliner
- powercli
- powershell
- scsi reservations
- VMware
- vsan
meta:
  _adinserter_block_exceptions: ''
  _thumbnail_id: '487'
  _dp_original: '194'
  _wp_desired_post_slug: ''
  _wp_old_slug: get-esxcli-get-changesettings-in-multiple-esxi-hosts-at-a-time
  _like_ip: a:0:{}
  _like_count: '0'
  _yoast_wpseo_primary_category: ''
  _yoast_wpseo_focuskw_text_input: PowerCLI
  _yoast_wpseo_focuskw: PowerCLI
  _yoast_wpseo_linkdex: '60'
  _yoast_wpseo_content_score: '30'
  post_views_count: '1'
  _edit_last: '5'
  _oembed_4579a308a898a5a98ae339bebe22ae2d: "{{unknown}}"
  np_single_post_sidebar: default_sidebar
  post_meta_identity: np-metabox-info
  _jetpack_related_posts_cache: a:1:{s:32:"8f6677c9d6b0f903e98ad32ec61f8deb";a:2:{s:7:"expires";i:1536024239;s:7:"payload";a:3:{i:0;a:1:{s:2:"id";i:385;}i:1;a:1:{s:2:"id";i:414;}i:2;a:1:{s:2:"id";i:685;}}}}
  _wpghs_github_path: _posts/2018-07-19-run-nested-esxi-on-top-vsan-datastore.md
  _sha: 7ea59b21bf26a435e49250f3d9c7e4bb6b8e3b58
author:
  login: ricardo.adao
  email: ricardo.adao@gmail.com
  display_name: Ricardo Adao
  first_name: Ricardo
  last_name: Adao
---
<p>Nested ESXi's are part of the gear that we all have around for labs/study purposes.</p>
<p>At this time stumbled in an error that was a bit a surprise, however in your troubleshooting process you end up checking logs and then going to your blogs of reference searching for answers.</p>
<p>And for me, <a href="https://www.virtuallyghetto.com">virtuallyGhetto</a> comes as one of the first places to look for answers for Nested Virtualization issues.</p>
<p>Link to the original post <a href="https://www.virtuallyghetto.com/2013/11/how-to-run-nested-esxi-on-top-of-vsan.html"><em>How to run Nested ESXi on top of a VSAN datastore?</em></a> from <a href="https://www.virtuallyghetto.com/author/lamw">William Lam</a>.</p>
<p>Back to the problem and solution.</p>
<p>Installing some ESXi 6.5 Nested Hypervisors that are running on top of a vSAN datastore, the installation process was bombing out complaining that it was unable to format the disks.</p>
<p><a href="https://vrandombites.co.uk/wp-content/uploads/2018/07/nested-hyp-vsan-problem.png"><img class="alignnone size-full wp-image-486" src="{{ site.baseurl }}/assets/nested-hyp-vsan-problem.png" alt="" width="561" height="477" /></a></p>
<p>After the search we got the answer from <a href="https://www.virtuallyghetto.com/author/lamw">William Lam</a> in <a href="https://www.virtuallyghetto.com/2013/11/how-to-run-nested-esxi-on-top-of-vsan.html"><em>How to run Nested ESXi on top of a VSAN datastore?</em></a></p>
<p>In summary, vSAN do not support <em>SCSI-2 Reservations</em> and since <em>VMware</em> internal development teams use heavily <em>Nested Virtualization</em> the <em>vSAN</em> team added a "workaround" to allow vSAN to <em>fake SCSI Reservations</em>.</p>
<p>This workaround is enabled by setting up an advanced property in each ESXi part of the vSAN cluster:</p>
<pre lang="shellscript">esxcli system settings advanced set -o /VSAN/FakeSCSIReservations -i 1</pre>
<p>Now that we have the answer and we have a couple of ESXi to setup this up, lets powershell it to make it quicker.</p>
<p>To check the current status:</p>
<pre lang="powershell">get-cluster -Name "{cluster name}" | Get-VMHost | `
  Sort-Object Name | `
  Select-Object Name, @{N="FakeSCSIResevations"; E={$_ | Get-AdvancedSetting -Name "VSAN.FakeSCSIReservations"}} | `
  Format-Table -AutoSize</pre>
<p>To set it up:</p>
<pre lang="powershell">get-cluster -Name "{cluster name}" | Get-VMHost | `
  Get-AdvancedSetting -Name "VSAN.FakeSCSIReservations" | `
  Set-AdvancedSetting -Value 1</pre>
