---
layout: post
author: Ricardo Adao
published: true
post_date: 2018-06-14 02:33:26
title: PowerCLI - Add vSAN Storage Policies and Set Virtual Machine Storage Policy
categories: [ powercli ]
tags: [ coding, powercli, powershell, spbm, vcenter, vcf, vmware, vsan ]
---
<p>There are multiple ways of adding extra storage policies and apply them to multiple <em>virtual machines</em> and plenty of <em>VMware</em> documentation and others to show how to do it.</p>
<p>But to reduce risk and minimize configuration drift, typically scripting/automating is the way to achieve that.</p>
<p>Hence we will try to quickly describe how to leverage some of the <em>VMware PowerCLI cmdlets</em> that can do this job for us.</p>
<p>And the better way of doing is using an example taken from our experience.</p>
<p>Our <strong>scenario </strong>is:</p>
<ul>
<li>Implementation is done via <em>VMware Cloud Foundation (VCF)</em></li>
<li><em>Consolidate Cluster Design</em></li>
<li><em>Management Virtual Machines</em> are all under specific <em>Resource Pools</em></li>
</ul>
<p>Our <strong>goals </strong>are:</p>
<ul>
<li>we want to setup a series of extra <em>vSAN Storage Policies</em></li>
<li>we want to change the <em>Storage Policy </em>assigned to all <em>Management Virtual Machines</em> to one of our new <em>Storage Policies</em></li>
<li>we want a script that can scale to any number of <em>Storage Policies</em> and <em>Virtual Machine Locations</em></li>
</ul>
<p>&nbsp;</p>
<p>This post will have 3 sections:</p>
<ol>
<li><strong>some structures and variables</strong> that will make our life easier later if we need to scale out the script</li>
<li><strong>loops</strong> where we create the storage policies and assign to the virtual machines</li>
<li><strong>the entire script</strong></li>
</ol>
<h2>Some structure and variables</h2>
<ul>
<li>Some variables with useful info that will be easier to keep on top to edit that go through the code
<pre lang="powershell"># Utility variables/constants
# Locations where the vms will be and policy to assign
# - Locations - see notes in the end of the post
$vmLocations = @(
    @{ location = "X-ResourcePool" ; policy = "management" } ; 
    @{ location = "Y-ResourcePool" ; policy = "raid5" }
)
# expreg with the name of the VMs that we do not want to change the assigned storage policy
$vmsToExcludeStoragePolicyChanges = "(DoNotChange_VM.*)|(NSX-Controller.*)"</pre>
</li>
<li>Our structure to define the multiple policies
<pre lang="powershell"># Policy definition
$vsanPoliciesProperties = @{
    "management" = @{
        "name" = "Management VMs Storage Policy" ;
        "description" = "Used for all management vms" ;
        "rulesets" = @(
            @{
                "name" = "Rule-set 1: VSAN" ;
                "rules" = @(
                    @{ "capability" = "VSAN.hostFailuresToTolerate" ; "value" = 1 } ,
                    @{ "capability" = "VSAN.replicaPreference" ; "value"= "RAID-1 (Mirroring) - Performance" }
                )
            }
        )
    } ;
    "raid5" = @{
        "name" = "VM Storage Policy - RAID5" ;
        "description" = "RAID5" ;
        "rulesets" = @(
            @{
                "name"  = "Rule-set 1: VSAN" ;
                "rules" = @(
                    @{ "capability" = "VSAN.hostFailuresToTolerate" ; "value" = 1 } ,
                    @{ "capability" = "VSAN.replicaPreference";"value"= "RAID-5/6 (Erasure Coding) - Capacity" }
                )
            }
        )
    }
}

# List of VSAN capabilities for reference
#Get-SpbmCapability VSAN*
#Name                                     ValueCollectionType ValueType
#VSAN.cacheReservation                                        System.Int32
#VSAN.checksumDisabled                                        System.Boolean
#VSAN.forceProvisioning                                       System.Boolean
#VSAN.hostFailuresToTolerate                                  System.Int32
#VSAN.iopsLimit                                               System.Int32
#VSAN.proportionalCapacity                                    System.Int32
#VSAN.replicaPreference                                       System.String
#VSAN.stripeWidth                                             System.Int32</pre>
</li>
<li><em>vsanPoliciesProperties</em> structure seems a bit too much, but the idea is to give the flexibility to add more <em>storage policies</em> if needed with a minimal change</li>
<li>An example of adding a policy will be adding one extra the <em>hash table</em>:
<ul>
<li><em>vsanPoliciesProperties</em>
<pre lang="powershell">...
    "newPolicy" = @{
        "name" = "VM Storage Policy - New Policy" ;
        "description" = "Im a example of a new storage policy" ;
        "rulesets" = @(
            @{
                "name"  = "Rule-set 1: VSAN" ;
                "rules" = @(
                    @{ "capability" = "VSAN.iopsLimit" ; "value" = 1000 } ,
                    @{ "capability" = "VSAN.stripeWidth" ; "value"= 2 }
                )
            }
        )
    }
...</pre>
</li>
</ul>
</li>
</ul>
<h2>Loops</h2>
<ul>
<li>There will be 2 loops, first creating the <em>storage policies</em> using the information from the structures described above, and a second where we will assign the virtual machines in each location in <em>$vmLocations</em> the respective <em>storage policy</em></li>
<li>
<h4>Creating <em>Storage Policies</em></h4>
<pre lang="powershell"># Setup policies
Write-Host "=&gt; Setup vSAN storage policies &lt;=" -ForegroundColor Green
Foreach($policyName in $vsanPoliciesProperties.Keys) {
    # Get specific properties for the policy to configure
    $policyProperties = $vsanPoliciesProperties.$policyName

    # Get and create rulesets
    $ruleSets = New-Object System.Collections.ArrayList
    Foreach($ruleSet in $policyProperties.rulesets ) {
        # Create array with the rules of each ruleset
        $rules = New-Object System.Collections.ArrayList
        Foreach( $rule in $ruleSet.rules ) {
            $rules += New-SpbmRule -Capability (Get-SpbmCapability -Name $rule.capability) -Value $rule.value
        }
        $ruleSets += New-SpbmRuleSet -Name $ruleSet.name -AllOfRules $rules
    }
    # Create policy
    New-SpbmStoragePolicy -Name $policyProperties.name -Description $policyProperties.description `
        -AnyOfRuleSets $ruleSets
}</pre>
</li>
<li>
<h4>Assigning <em>Storage Policies</em></h4>
<pre lang="powershell">$clusters = Get-Cluster
Foreach($cluster in $clusters) {
    
    # Change VSAN storage policy for Management VMs
    Write-Host "=&gt; Setup vSAN storage policies - $($vsanPoliciesProperties.management.name) &lt;=" `
       -ForegroundColor Green
    # For each of the Resource Pools with Management VMs
    Foreach($vmLocation in $vmLocations) {
       # for each resourcePool
       $vms = $cluster | Get-ResourcePool -Name $vmLocation.location | Get-VM | `
          Where-Object { $_.Name -notmatch $vmsToExcludeStoragePolicyChanges}
       if($vms.Count) {
          Write-Host "==&gt; Setup vSAN storage policies - Virtual Machines in $($vmLocation.location) - `
             Policy: $($vsanPoliciesProperties.($vmLocation.policy).name) &lt;==" -ForegroundColor Green
          # Set VMs Storage Policy
          $vms | Set-SpbmEntityConfiguration -SpbmEnabled $true -StoragePolicy (Get-SpbmStoragePolicy `
             -Name ($vsanPoliciesProperties.($vmLocation.policy).name)) | `
             Select-Object Name, StoragePolicy | Format-Table -AutoSize
          # Set VMs All vDisks
          $vms | Get-HardDisk | `
          Set-SpbmEntityConfiguration -SpbmEnabled $true -StoragePolicy (Get-SpbmStoragePolicy `
             -Name ($vsanPoliciesProperties.($vmLocation.policy).name)) | `
             Select-Object @{N="VM Name";E={Get-VM -Id ($_.Id).Split("/")[0]}}, Name, StoragePolicy |`
             Format-Table -AutoSize
        }
    }
}</pre>
</li>
</ul>
<h4>Putting all together in an example script</h4>
<ul>
<li><strong>Last notes:</strong>
<ul>
<li><em>Consolidate Cluster Design</em> means that <em>Management Virtual Machines</em> will be assigned under a <em>Management Resource Pool</em>, instead of a <em>Dedicated VMware Cluster</em></li>
<li>Will be easy to adapt the script to allow the use of any type of <em>Location</em> besides <em>Resource Pools</em> (something that could be covered later in another post)</li>
<li>Code should have enough comments to be easy to read, however feel free to reach out if needed</li>
<li>Post do not cover detailed explanation of <em>VMware PowerCLI cmdlets</em>, since <em>VMware</em> documentation is really good, some of the links:
<ul>
<li><a href="https://pubs.vmware.com/vsphere-6-5/index.jsp?topic=%2Fcom.vmware.powercli.cmdletref.doc%2FSet-SpbmStoragePolicy.html">Set-SpbmStoragePolicy</a></li>
<li><a href="https://pubs.vmware.com/vsphere-6-5/topic/com.vmware.powercli.cmdletref.doc/Get-SpbmStoragePolicy.html">Get-SpbmStoragePolicy</a></li>
<li><a href="https://pubs.vmware.com/vsphere-6-5/index.jsp?topic=%2Fcom.vmware.powercli.cmdletref.doc%2FSet-SpbmStoragePolicy.html">Set-SpbmStoragePolicy</a></li>
<li><a href="https://pubs.vmware.com/vsphere-6-5/topic/com.vmware.powercli.cmdletref.doc/Get-SpbmEntityConfiguration.html">Get-SpbmEntityConfiguration</a></li>
<li><a href="https://pubs.vmware.com/vsphere-6-5/index.jsp?topic=%2Fcom.vmware.powercli.cmdletref.doc%2FSet-SpbmStoragePolicy.html">Set-SpbmStoragePolicy</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<ul>
<li>
<h3><strong><em>Github</em> Link for the entire script:</strong> <a href="https://github.com/ricardonadao/vrandombites.co.uk/blob/master/vSAN/setup.vsan.storage.policies.ps1">setup.vsan.storage.policies.ps1</a></h3>
</li>
</ul>
