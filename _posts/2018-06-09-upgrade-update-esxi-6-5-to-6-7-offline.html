---
layout: post
author: Ricardo Adao
published: true
post_date: 2018-06-09 11:59:58
title: Upgrade/Update ESXi 6.5 to 6.7 Offline
categories: [ esxi ]
tags: [ esxi, hypervisor, vmware, upgrade, vsphere ]
---
<p>In our <em>Homelabs</em>, we normally make some "architecture compromises" that add some extra complexity when we need to upgrade it.</p>
<p>And in my particular case, was starting with a "single host" with enough resources to run a couple of <em>Nested Environments</em>, there are plans  to add one or two more hosts, but for now has been enough for the current use.</p>
<p>Running everything from a single host creates some challenges when is time for BIOS/Firmware updates and ESXi upgrade/update.</p>
<p>So let's do a quick run of the process to upgrade an ESXi hypervisor offline:</p>
<p><em>(remember your mileage may vary in some of the parts, but the process should work for more than ESXi 6.5 to ESXi 6.7 upgrade)</em></p>
<ol>
<li><strong>Download the offline bundle and upload to a local datastore</strong>
<ul>
<li>Not describing the download process and upload, since there are different ways to achieve this.<br />
<a href="https://vrandombites.co.uk/wp-content/uploads/2018/06/esxi-upgrade-offlinePatch.png"><img class="alignnone size-full wp-image-388" src="{{ site.baseurl }}/assets/esxi-upgrade-offlinePatch.png" alt="" width="744" height="95" /></a></li>
</ul>
</li>
<li><strong>Shutdown all your VMs</strong></li>
<li><strong>Do a dry run just to make sure</strong>
<ul>
<li>
<pre lang="bash">esxcli software profile update -d /vmfs/volumes//VMware-ESXi-6.7.0-8169922-depot.zip -p ESXi-6.7.0-8169922-standard --dry-run</pre>
<p><a href="https://vrandombites.co.uk/wp-content/uploads/2018/06/esxi-upgrade-dryrun.png"><img class="alignnone size-full wp-image-389" src="{{ site.baseurl }}/assets/esxi-upgrade-dryrun.png" alt="" width="1247" height="391" /></a></li>
<li>This <em>dry-run</em> will give us a list of what will be applied and installed.</li>
</ul>
</li>
<li><strong>Enter <em>Maintenance Mode</em></strong>
<ul>
<li>
<pre lang="bash">esxcli system maintenanceMode get
esxcli system maintenanceMode set --enable=true
esxcli system maintenanceMode get</pre>
<p><a href="https://vrandombites.co.uk/wp-content/uploads/2018/06/esxi-upgrade-enterMaintenanceMode.png"><img class="alignnone size-full wp-image-391" src="{{ site.baseurl }}/assets/esxi-upgrade-enterMaintenanceMode.png" alt="" width="442" height="78" /></a></li>
</ul>
</li>
<li><strong>Fire the upgrade away</strong>
<ul>
<li>And we are ready for the upgrade</li>
<li>
<pre lang="bash">esxcli software profile update -d /vmfs/volumes//VMware-ESXi-6.7.0-8169922-depot.zip -p ESXi-6.7.0-8169922-standard --dry-run</pre>
<p><a href="https://vrandombites.co.uk/wp-content/uploads/2018/06/esxi-upgrade-start.png"><img class="alignnone size-full wp-image-392" src="{{ site.baseurl }}/assets/esxi-upgrade-start.png" alt="" width="1247" height="35" /></a></li>
<li>The command is not too verbose, but we can open a 2nd SSH session and tail the <em>esxupdate.log</em> file<br />
<a href="https://vrandombites.co.uk/wp-content/uploads/2018/06/esxi-upgrade-tail-esxupdate.png"><img class="alignnone size-full wp-image-394" src="{{ site.baseurl }}/assets/esxi-upgrade-tail-esxupdate.png" alt="" width="337" height="26" /></a></li>
<li>Will give you a quick report, similar to the <em>dry-run</em>, but now with the actual changes<br />
<a href="https://vrandombites.co.uk/wp-content/uploads/2018/06/esxi-upgrade-finished.png"><img class="alignnone size-full wp-image-395" src="{{ site.baseurl }}/assets/esxi-upgrade-finished.png" alt="" width="1251" height="195" /></a></li>
</ul>
</li>
<li><strong>Reboot</strong>
<ul>
<li>Now, we need to reboot the host to get the upgrade finished<br />
<a href="https://vrandombites.co.uk/wp-content/uploads/2018/06/esxi-upgrade-reboot.png"><img class="alignnone size-full wp-image-396" src="{{ site.baseurl }}/assets/esxi-upgrade-reboot.png" alt="" width="591" height="24" /></a></li>
</ul>
</li>
<li><strong>Take out of <em>Maintenance Mode</em></strong>
<ul>
<li>Host up, let's remove it from <em>Maintenance Mode</em><br />
<a href="https://vrandombites.co.uk/wp-content/uploads/2018/06/esxi-upgrade-firstBoot.png"><img class="alignnone size-full wp-image-399" src="{{ site.baseurl }}/assets/esxi-upgrade-firstBoot.png" alt="" width="468" height="445" /></a></li>
<li>
<pre lang="bash">esxcli system maintenanceMode get
esxcli system maintenanceMode set --enable=false
esxcli system maintenanceMode get</pre>
<p><a href="https://vrandombites.co.uk/wp-content/uploads/2018/06/esxi-upgrade-exitMaintenanceMode.png"><img class="alignnone size-full wp-image-400" src="{{ site.baseurl }}/assets/esxi-upgrade-exitMaintenanceMode.png" alt="" width="447" height="127" /></a></li>
</ul>
</li>
<li><strong>And all done</strong>
<ul>
<li>A picture worth 1000 words they say.<br />
<a href="https://vrandombites.co.uk/wp-content/uploads/2018/06/esxi-upgrade-UpdatedESXi.png"><img class="alignnone size-full wp-image-403" src="{{ site.baseurl }}/assets/esxi-upgrade-UpdatedESXi.png" alt="" width="340" height="198" /></a></li>
</ul>
</li>
</ol>
